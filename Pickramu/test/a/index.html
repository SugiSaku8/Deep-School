<!DOCTYPE html>
<html>
  <head>
    <title>Markdown Viewer</title>
    <style>
      /* スタイルはここに記述 */
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <div id="content" style="display: none">
      <!-- Markdownコンテンツがここに表示される -->
    </div>

    <script>
      let scriptsToEval = []; // 実行するスクリプトを格納する配列

      function evalrun(code) {
        try {
          eval(code);
        } catch (error) {
          console.error("Error executing script:", error);
        }
      }

      function loadMarkdown(file) {
        fetch(file)
          .then((response) => response.text())
          .then((markdown) => {
            const html = parseMarkdown(markdown);
            document.getElementById("content").innerHTML = html;
            document.getElementById("content").style.display = "block"; // コンテンツを表示

            // すべてのスクリプトを実行
            scriptsToEval.forEach((script) => {
              evalrun(script);
            });
            scriptsToEval = []; // 配列をクリア
          })
          .catch((error) => console.error("Error loading markdown:", error));
      }

      function parseMarkdown(markdown) {
        markdown = markdown.replace(
          /@config \[open\]([\s\S]*?)@config \[close\]/g,
          ""
        );
        markdown = markdown.replace(
          /@style \[open\]([\s\S]*?)@style \[close\]/g,
          (match, styleContent) => {
            console.log("styleContent:", styleContent);
            // スタイルをJavaScriptオブジェクトとして格納
            const styleObject = parseStyles(styleContent);
            console.log("styleObject:", styleObject);
            // スタイルを適用するスクリプトを生成
            const styleScript = generateStyleScript(styleObject);
             console.log("styleScript:", styleScript);
            // スクリプトをscriptsToEvalに追加
            scriptsToEval.push(styleScript);
            return ""; // スタイルタグを削除
          }
        );

        // tag, btn, scriptタグを処理
        markdown = markdown.replace(
          /@tag (\w+) \[(open|close)\s?(\^hide\^)?\]([\s\S]*?)@tag \w+ \[close\]/g,
          (match, tagName, openClose, hide, tagContent) => {
            let style = "";
            if (hide === "^hide^") {
              style = "display: none !important;";
            } else {
              style = ""; // スタイルが適用されない場合でも空の文字列を設定
            }
            const parsedTagContent = marked.parse(tagContent);
            return `<div id="${tagName}" style="${style}">${parsedTagContent}</div>`;
          }
        );
        markdown = markdown.replace(
          /@btn id=(\w+) ([\s\S]*)/g,
          (match, btnId, btnContent) => {
            const content = btnContent.replace(/^id=/, "").trim();
            return `<button id="${btnId}">${content}</button>`;
          }
        );
        markdown = markdown.replace(
          /@script on=(\w+) \[open\]([\s\S]*?)@script \[close\]/g,
          (match, onId, scriptContent) => {
            console.log("id:" + onId);
            console.log("scriptContent:" + scriptContent);

            // HTMLエンティティをデコード
            const decodedScript = scriptContent
              .replace(/&lt;/g, "<")
              .replace(/&gt;/g, ">")
              .replace(/&amp;/g, "&");

            // スクリプトを配列に格納
            scriptsToEval.push(`
              (function() {
                const btn = document.getElementById("${onId}");
                if (btn) {
                  btn.addEventListener('click', function() {
                    evalrun(\`${decodedScript}\`);
                  });
                } else {
                  console.error("Button with id '${onId}' not found");
                }
              })();
            `);
            return "";
          }
        );

        // marked.jsを使用してMarkdownをHTMLに変換
        markdown = marked.parse(markdown);

        return markdown;
      }

      // ページのロード時にMarkdownファイルを読み込む
      window.onload = function () {
        loadMarkdown("test.md"); // Markdownファイルのパス
      };

      // domオブジェクトを定義
      const dom = {
        Tag: function (tagName) {
          const element = document.getElementById(tagName);
          return {
            style: {
              display: function (displayValue, important) {
                element.style.display = displayValue;
                if (important === "auto") {
                  element.style.setProperty(
                    "display",
                    displayValue,
                    "important"
                  );
                }
              },
            },
          };
        },
      };
    </script>

    <script>
      // CSSライクな文字列をJavaScriptオブジェクトに変換する関数
      function parseStyles(styleContent) {
        const styles = {};
        styleContent.split("\n").forEach((line) => {
          line = line.trim();
          if (!line) return; // 空行を無視

          const match = line.match(/#(\w+)\s*\{([\s\S]*?)\}/);
          if (match) {
            const id = match[1];
            const css = match[2].trim();
            styles[id] = {};

            css.split(";").forEach((cssLine) => {
              cssLine = cssLine.trim();
              if (!cssLine) return; // 空のCSS行を無視

              const cssMatch = cssLine.match(/(\w+)\s*:\s*([^;]+)/);
              if (cssMatch) {
                const property = cssMatch[1].trim();
                const value = cssMatch[2].trim();
                styles[id][property] = value;
              }
            });
          } else if (line) {
            console.warn("Invalid style line:", line);
          }
        });
        return styles;
      }

      // スタイルを適用するスクリプトを生成する関数
      function generateStyleScript(styleObject) {
        console.log("generateStyleScript called with:", styleObject);
        return `(function() {
          for (const id in styleObject) {
            if (styleObject.hasOwnProperty(id)) {
              const element = document.getElementById(id);
              if (element) {
                console.log("Element found:", element);
                const style = styleObject[id];
                for (const property in style) {
                  if (style.hasOwnProperty(property)) {
                    console.log(`Setting ${property} to ${style[property]} on element ${id}`);
                    element.style[property] = style[property];
                  }
                }
              } else {
                console.error(`Element with id '${id}' not found`);
              }
            }
          }
        })();`;
      }
    </script>
  </body>
</html>