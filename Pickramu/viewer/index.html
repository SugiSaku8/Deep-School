<!DOCTYPE html>
<html>
  <head>
    <title>Markdown Viewer</title>
    <style>
      #red {
        color: red;
      }
      #testB {
        display: none;
      }
      .pickcontent #red {
        color: red;
      }
      .pickcontent #red {
        color: red;
      }
      .pickcontent #aliceblue {
        color: aliceblue;
      }

      .pickcontent #antiquewhite {
        color: antiquewhite;
      }

      .pickcontent #aqua {
        color: aqua;
      }

      .pickcontent #aquamarine {
        color: aquamarine;
      }

      .pickcontent #azure {
        color: azure;
      }

      .pickcontent #beige {
        color: beige;
      }

      .pickcontent #bisque {
        color: bisque;
      }

      .pickcontent #black {
        color: black;
      }

      .pickcontent #blanchedalmond {
        color: blanchedalmond;
      }

      .pickcontent #blue {
        color: blue;
      }

      .pickcontent #blueviolet {
        color: blueviolet;
      }

      .pickcontent #brown {
        color: brown;
      }

      .pickcontent #burlywood {
        color: burlywood;
      }

      .pickcontent #cadetblue {
        color: cadetblue;
      }

      .pickcontent #chartreuse {
        color: chartreuse;
      }

      .pickcontent #chocolate {
        color: chocolate;
      }

      .pickcontent #coral {
        color: coral;
      }

      .pickcontent #cornflowerblue {
        color: cornflowerblue;
      }

      .pickcontent #cornsilk {
        color: cornsilk;
      }

      .pickcontent #crimson {
        color: crimson;
      }

      .pickcontent #cyan {
        color: cyan;
      }

      .pickcontent #darkblue {
        color: darkblue;
      }

      .pickcontent #darkcyan {
        color: darkcyan;
      }

      .pickcontent #darkgoldenrod {
        color: darkgoldenrod;
      }

      .pickcontent #darkgray {
        color: darkgray;
      }

      .pickcontent #darkgreen {
        color: darkgreen;
      }

      .pickcontent #darkkhaki {
        color: darkkhaki;
      }

      .pickcontent #darkmagenta {
        color: darkmagenta;
      }

      .pickcontent #darkolivegreen {
        color: darkolivegreen;
      }

      .pickcontent #darkorange {
        color: darkorange;
      }

      .pickcontent #darkorchid {
        color: darkorchid;
      }

      .pickcontent #darkred {
        color: darkred;
      }

      .pickcontent #darksalmon {
        color: darksalmon;
      }

      .pickcontent #darkseagreen {
        color: darkseagreen;
      }

      .pickcontent #darkslateblue {
        color: darkslateblue;
      }

      .pickcontent #darkslategray {
        color: darkslategray;
      }

      .pickcontent #darkturquoise {
        color: darkturquoise;
      }

      .pickcontent #darkviolet {
        color: darkviolet;
      }

      .pickcontent #deeppink {
        color: deeppink;
      }

      .pickcontent #deepskyblue {
        color: deepskyblue;
      }

      .pickcontent #dimgray {
        color: dimgray;
      }

      .pickcontent #dodgerblue {
        color: dodgerblue;
      }

      .pickcontent #firebrick {
        color: firebrick;
      }

      .pickcontent #floralwhite {
        color: floralwhite;
      }

      .pickcontent #forestgreen {
        color: forestgreen;
      }

      .pickcontent #fuchsia {
        color: fuchsia;
      }

      .pickcontent #gainsboro {
        color: gainsboro;
      }

      .pickcontent #ghostwhite {
        color: ghostwhite;
      }

      .pickcontent #gold {
        color: gold;
      }

      .pickcontent #goldenrod {
        color: goldenrod;
      }

      .pickcontent #gray {
        color: gray;
      }

      .pickcontent #green {
        color: green;
      }

      .pickcontent #greenyellow {
        color: greenyellow;
      }

      .pickcontent #honeydew {
        color: honeydew;
      }

      .pickcontent #hotpink {
        color: hotpink;
      }

      .pickcontent #indianred {
        color: indianred;
      }

      .pickcontent #indigo {
        color: indigo;
      }

      .pickcontent #ivory {
        color: ivory;
      }

      .pickcontent #khaki {
        color: khaki;
      }

      .pickcontent #lavender {
        color: lavender;
      }

      .pickcontent #lavenderblush {
        color: lavenderblush;
      }

      .pickcontent #lawngreen {
        color: lawngreen;
      }

      .pickcontent #lemonchiffon {
        color: lemonchiffon;
      }

      .pickcontent #lightblue {
        color: lightblue;
      }

      .pickcontent #lightcoral {
        color: lightcoral;
      }

      .pickcontent #lightcyan {
        color: lightcyan;
      }

      .pickcontent #lightgoldenrodyellow {
        color: lightgoldenrodyellow;
      }

      .pickcontent #lightgray {
        color: lightgray;
      }

      .pickcontent #lightgreen {
        color: lightgreen;
      }

      .pickcontent #lightpink {
        color: lightpink;
      }

      .pickcontent #lightsalmon {
        color: lightsalmon;
      }

      .pickcontent #lightseagreen {
        color: lightseagreen;
      }

      .pickcontent #lightskyblue {
        color: lightskyblue;
      }

      .pickcontent #lightslategray {
        color: lightslategray;
      }

      .pickcontent #lightsteelblue {
        color: lightsteelblue;
      }

      .pickcontent #lightyellow {
        color: lightyellow;
      }

      .pickcontent #lime {
        color: lime;
      }

      .pickcontent #limegreen {
        color: limegreen;
      }

      .pickcontent #linen {
        color: linen;
      }

      .pickcontent #magenta {
        color: magenta;
      }

      .pickcontent #maroon {
        color: maroon;
      }

      .pickcontent #mediumaquamarine {
        color: mediumaquamarine;
      }

      .pickcontent #mediumblue {
        color: mediumblue;
      }

      .pickcontent #mediumorchid {
        color: mediumorchid;
      }

      .pickcontent #mediumpurple {
        color: mediumpurple;
      }

      .pickcontent #mediumseagreen {
        color: mediumseagreen;
      }

      .pickcontent #mediumslateblue {
        color: mediumslateblue;
      }

      .pickcontent #mediumspringgreen {
        color: mediumspringgreen;
      }

      .pickcontent #mediumturquoise {
        color: mediumturquoise;
      }

      .pickcontent #mediumvioletred {
        color: mediumvioletred;
      }

      .pickcontent #midnightblue {
        color: midnightblue;
      }

      .pickcontent #mintcream {
        color: mintcream;
      }

      .pickcontent #mistyrose {
        color: mistyrose;
      }

      .pickcontent #moccasin {
        color: moccasin;
      }

      .pickcontent #navajowhite {
        color: navajowhite;
      }

      .pickcontent #navy {
        color: navy;
      }

      .pickcontent #oldlace {
        color: oldlace;
      }

      .pickcontent #olive {
        color: olive;
      }

      .pickcontent #olivedrab {
        color: olivedrab;
      }

      .pickcontent #orange {
        color: orange;
      }

      .pickcontent #orangered {
        color: orangered;
      }

      .pickcontent #orchid {
        color: orchid;
      }

      .pickcontent #palegoldenrod {
        color: palegoldenrod;
      }

      .pickcontent #palegreen {
        color: palegreen;
      }

      .pickcontent #paleturquoise {
        color: paleturquoise;
      }

      .pickcontent #palevioletred {
        color: palevioletred;
      }

      .pickcontent #papayawhip {
        color: papayawhip;
      }

      .pickcontent #peachpuff {
        color: peachpuff;
      }

      .pickcontent #peru {
        color: peru;
      }

      .pickcontent #pink {
        color: pink;
      }

      .pickcontent #plum {
        color: plum;
      }

      .pickcontent #powderblue {
        color: powderblue;
      }

      .pickcontent #purple {
        color: purple;
      }

      .pickcontent #rebeccapurple {
        color: rebeccapurple;
      }

      .pickcontent #rosybrown {
        color: rosybrown;
      }

      .pickcontent #royalblue {
        color: royalblue;
      }

      .pickcontent #saddlebrown {
        color: saddlebrown;
      }

      .pickcontent #salmon {
        color: salmon;
      }

      .pickcontent #sandybrown {
        color: sandybrown;
      }

      .pickcontent #seagreen {
        color: seagreen;
      }

      .pickcontent #seashell {
        color: seashell;
      }

      .pickcontent #sienna {
        color: sienna;
      }

      .pickcontent #silver {
        color: silver;
      }

      .pickcontent #skyblue {
        color: skyblue;
      }

      .pickcontent #slateblue {
        color: slateblue;
      }

      .pickcontent #slategray {
        color: slategray;
      }

      .pickcontent #snow {
        color: snow;
      }

      .pickcontent #springgreen {
        color: springgreen;
      }

      .pickcontent #steelblue {
        color: steelblue;
      }

      .pickcontent #tan {
        color: tan;
      }

      .pickcontent #teal {
        color: teal;
      }

      .pickcontent #thistle {
        color: thistle;
      }

      .pickcontent #tomato {
        color: tomato;
      }

      .pickcontent #turquoise {
        color: turquoise;
      }

      .pickcontent #violet {
        color: violet;
      }

      .pickcontent #wheat {
        color: wheat;
      }

      .pickcontent #white {
        color: white;
      }

      .pickcontent #whitesmoke {
        color: whitesmoke;
      }

      .pickcontent #yellow {
        color: yellow;
      }

      .pickcontent #yellowgreen {
        color: yellowgreen;
      }

      .pickcontent h1 {
        font-size: 2em;
        margin: 0.2em 0;
      }

      .pickcontent .unit-title {
        font-weight: bold;
        font-size: 1.5em;
      }

      .pickcontent .chapter-title {
        font-weight: bold;
        font-size: 2em;
      }

      .pickcontent .question {
        font-size: 1.7em;
        margin: 0.5em 0;
      }

      .pickcontent .equations {
        font-size: 1.6em;
        line-height: 1.6;
      }

      .pickcontent .input-container {
        display: flex;
        margin-top: 2em;
        gap: 1em;
      }

      .pickcontent .input-box {
        background-color: #a3b1a6;
        border-radius: 25px;
        padding: 0.8em 2em;
        font-size: 1.6em;
        color: white;
        border: none;
        width: 300px;
      }

      .pickcontent .button-next {
        background-color: #33aaff;
        border: none;
        border-radius: 25px;
        padding: 0.8em 2em;
        font-size: 1.6em;
        color: white;
        cursor: pointer;
      }

      .pickcontent .footer-bar {
        position: absolute;
        bottom: 0;
        width: 100%;
        height: 20px;
        background: linear-gradient(to right, #dca10d, #8c5d00);
      }
      #n2 {
        display: none;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <input type="file" id="fileInput" accept=".md" />
    <div id="content" style="display: none">
      <!-- Markdownコンテンツがここに表示される -->
    </div>

    <script>
      /**
       * @type {Array<string>} scriptsToEval - 実行するスクリプトを格納する配列
       */
      let scriptsToEval = []; // 実行するスクリプトを格納する配列

      /**
       * evalrun - 与えられたコードをevalで実行し、エラーがあればconsole.errorに出力する。
       *
       * @param {string} code - 実行するJavaScriptコード
       * @returns {void}
       */
      function evalrun(code) {
        try {
          eval(code);
        } catch (error) {
          console.error("Error executing script:", error);
        }
      }

      /**
       * loadMarkdown - Markdownファイルを読み込み、HTMLに変換して指定された要素に表示する。
       *
       * @param {string} file - Markdownファイルのパス
       * @returns {void}
       */
      function loadMarkdown(file) {
        fetch(file)
          .then((response) => response.text())
          .then((markdown) => {
            const html = parseMarkdown(markdown);
            document.getElementById("content").innerHTML = html;
            document.getElementById("content").style.display = "block"; // コンテンツを表示

            // すべてのスクリプトを実行
            scriptsToEval.forEach((script) => {
              evalrun(script);
            });
            scriptsToEval = []; // 配列をクリア
          })
          .catch((error) => console.error("Error loading markdown:", error));
      }

      /**
       * parseMarkdown - Markdownテキストを解析し、カスタムタグを処理してHTMLに変換する。
       *
       * @param {string} markdown - Markdown形式のテキスト
       * @returns {string} - 変換されたHTML
       */
      function parseMarkdown(markdown) {
        markdown = markdown.replace(
          /@config \[open\]([\s\S]*?)@config \[close\]/g,
          ""
        );

        // tag, btn, scriptタグを処理
        markdown = markdown.replace(
          /@tag ([\w-]+) \[(open|close)\s?(\^hide\^)?\]([\s\S]*?)@tag \w+ \[close\]/g,
          (match, tagName, openClose, hide, tagContent) => {
            let style = "";
            if (hide === "^hide^") {
              style = "display: none !important;";
            } else {
              style = ""; // スタイルが適用されない場合でも空の文字列を設定
            }

            // @btn を抽出
            const btnRegex = /@btn id=(\w+) ([\s\S]*)/g;
            let btnMatch;
            let processedTagContent = tagContent;
            while ((btnMatch = btnRegex.exec(tagContent)) !== null) {
              const btnId = btnMatch[1];
              const btnContent = btnMatch[2].trim();
              const btnHtml = `<button id="${btnId}">${btnContent}</button>`;

              // tagContentから@btnを削除
              processedTagContent = processedTagContent.replace(
                btnMatch[0],
                ""
              );

              // @btnを挿入する場所を特定 (ここではtagContentの最後に挿入)
              processedTagContent += btnHtml;
            }

            const parsedTagContent = marked.parse(processedTagContent);
            return `<div id="${tagName}" style="${style}">${parsedTagContent}</div>`;
          }
        );
        markdown = markdown.replace(
          /@btn id=(\w+) ([\s\S]*)/g,
          (match, btnId, btnContent) => {
            //const content = btnContent.replace(/^id=/, "").trim();
            //return `<button id="${btnId}">${content}</button>`;
            return "";
          }
        );
        markdown = markdown.replace(
          /@script on=(\w+) \[open\]([\s\S]*?)@script \[close\]/g,
          (match, onId, scriptContent) => {
            // HTMLエンティティをデコード
            const decodedScript = scriptContent
              .replace(/&lt;/g, "<")
              .replace(/&gt;/g, ">")
              .replace(/&amp;/g, "&");

            // スクリプトを配列に格納
            scriptsToEval.push(`
              (function() {
                const btn = document.getElementById("${onId}");
                if (btn) {
                  btn.addEventListener('click', function() {
                    evalrun(\`${decodedScript}\`);
                  });
                } else {
                  console.error("Button with id '${onId}' not found");
                }
              })();
            `);
            return "";
          }
        );

        // marked.jsを使用してMarkdownをHTMLに変換
        markdown = marked.parse(markdown);

        return markdown;
      }

      /**
       * dom - DOM操作を簡単にするためのオブジェクト
       * @namespace dom
       */
      //How to use
      //window.onload = function () {
      //  loadMarkdown(filepath); // Markdownファイルのパス
      //};
      // ページのロード時にMarkdownファイルを読み込む
      window.onload = function () {
        //loadMarkdown("test.md"); // Markdownファイルのパス
        document
          .getElementById("fileInput")
          .addEventListener("change", handleFileSelect);
      };

      // domオブジェクトを定義
      const dom = {
        Tag: function (tagName) {
          const element = document.getElementById(tagName);
          return {
            style: {
              display: function (displayValue, important) {
                element.style.display = displayValue;
                if (important === "auto") {
                  element.style.setProperty(
                    "display",
                    displayValue,
                    "important"
                  );
                }
              },
            },
          };
        },
      };
    </script>
  </body>
</html>
